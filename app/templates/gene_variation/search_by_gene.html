{% extends 'base.html' %}
{% block content %}
<h2>Search for Variation by Gene:</h2>
<form role="search" method="" action="#">
    <div class="input-group">
        <table class="table">
        <tr>
        <td colspan="2">
         Gene ID/Symbol/Name<input id="gene_name" type="text" name='gene' class="form-control" value="" placeholder="Input one Gene Symbol/Name">
        </td>
        </tr>
        <tr>
        <td>
        Upstream (kb, optional, must &lt;&#61; 10kb) <input id="up" type="text" name='up' class="form-control" value=2 placeholder="Upstream Region(kb)">
        </td>
        <td>
        Downstream (kb, optional, must  &lt;&#61; 10kb) <input id="down" type="text" name='down' class="form-control" value=1 placeholder="Downstream Region(Kb)">
        </td>
        </tr>
        <!--
        <tr>
        <td>
        <div class="input-group-btn">
            <button id="submit" type="submit" class="btn btn-success btn-sm">
                Submit
            </button>
        </div>
        </td>
        </tr>
        -->
        </table>
    </div>
</form>
<div>
  <h2>Divide groups:</h2>
  <div class="panel-heading">
  <h3 class="panel-title">Divide samples which showed below to two groups.</h3>
  </div>
  <div class="row">
    <div class="col-xs-5">
        <select name="from[]" id="multi_d" class="form-control" size="26" multiple="multiple">
          {% for sample in samples %}
          <option value="{{ sample }}">{{ sample }}</option>
          {% endfor %}
        </select>
    </div>

    <div class="col-xs-2">
        <button type="button" id="multi_d_rightAll" class="btn btn-default btn-block" style="margin-top: 20px;"><i class="glyphicon glyphicon-forward"></i>&nbsp;ADD ALL</button>
        <button type="button" id="multi_d_rightSelected" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-right"></i>&nbsp;ADD</button>
        <button type="button" id="multi_d_leftSelected" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-left"></i>&nbsp;REMOVE</button>
        <button type="button" id="multi_d_leftAll" class="btn btn-default btn-block"><i class="glyphicon glyphicon-backward"></i>&nbsp;REMOVE ALL</button>

        <hr style="margin: 40px 0 60px;" />

        <button type="button" id="multi_d_rightAll_2" class="btn btn-default btn-block"><i class="glyphicon glyphicon-forward"></i>&nbsp;ADD ALL</button>
        <button type="button" id="multi_d_rightSelected_2" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-right"></i>&nbsp;ADD</button>
        <button type="button" id="multi_d_leftSelected_2" class="btn btn-default btn-block"><i class="glyphicon glyphicon-chevron-left"></i>&nbsp;REMOVE</button>
        <button type="button" id="multi_d_leftAll_2" class="btn btn-default btn-block"><i class="glyphicon glyphicon-backward"></i>&nbsp;REMOVE ALL</button>
    </div>

    <div class="col-xs-5">
        <b>group A</b>
        <select name="to[]" id="multi_d_to" class="form-control" size="8" multiple="multiple"></select>

        <br/><hr/><br/>

        <b>group B</b>
        <select name="to_2[]" id="multi_d_to_2" class="form-control" size="8" multiple="multiple"></select>
    </div>
</div>
</div>
<div class="panel-body">
  <input class="btn btn-success btn-sm"  id="submit" type="submit"  value="Submit">
</div>
<hr/>
<h2>Search Results:</h2>
<div id="results-table"></div>
{% endblock %}

{% block js %}
<script src="/static/js/main.js"></script>
<script>
function check_gene(info){
  var keys = Object.keys(info);
  for(var i = 0; i < keys.length; i++){
    if(info[keys[i]].length == 0){
      alert(keys[i] + ' is empty!');
      return false;
    }
  }
  if(Number(info['gene_upstream']) > 2 || Number(info['gene_downstream'] > 2)){
    alert('upstream & downstream not allowed > 2');
    return false;
  }else{
    return true;
  }
}
$(document).ready(function(){
  // multiselect plugin
  $('#multi_d').multiselect({
    right: '#multi_d_to, #multi_d_to_2',
    rightSelected: '#multi_d_rightSelected, #multi_d_rightSelected_2',
    leftSelected: '#multi_d_leftSelected, #multi_d_leftSelected_2',
    rightAll: '#multi_d_rightAll, #multi_d_rightAll_2',
    leftAll: '#multi_d_leftAll, #multi_d_leftAll_2',

    search: {
        left: '<input type="text" name="q" class="form-control" placeholder="Search..." />'
    },

    moveToRight: function(Multiselect, $options, event, silent, skipStack) {
        var button = $(event.currentTarget).attr('id');

        if (button == 'multi_d_rightSelected') {
            var $left_options = Multiselect.$left.find('> option:selected');
            Multiselect.$right.eq(0).append($left_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$right.eq(0).find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$right.eq(0));
            }
        } else if (button == 'multi_d_rightAll') {
            var $left_options = Multiselect.$left.children(':visible');
            Multiselect.$right.eq(0).append($left_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$right.eq(0).find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$right.eq(0));
            }
        } else if (button == 'multi_d_rightSelected_2') {
            var $left_options = Multiselect.$left.find('> option:selected');
            Multiselect.$right.eq(1).append($left_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$right.eq(1).find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$right.eq(1));
            }
        } else if (button == 'multi_d_rightAll_2') {
            var $left_options = Multiselect.$left.children(':visible');
            Multiselect.$right.eq(1).append($left_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$right.eq(1).eq(1).find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$right.eq(1));
            }
        }
    },

    moveToLeft: function(Multiselect, $options, event, silent, skipStack) {
        var button = $(event.currentTarget).attr('id');

        if (button == 'multi_d_leftSelected') {
            var $right_options = Multiselect.$right.eq(0).find('> option:selected');
            Multiselect.$left.append($right_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$left.find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$left);
            }
        } else if (button == 'multi_d_leftAll') {
            var $right_options = Multiselect.$right.eq(0).children(':visible');
            Multiselect.$left.append($right_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$left.find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$left);
            }
        } else if (button == 'multi_d_leftSelected_2') {
            var $right_options = Multiselect.$right.eq(1).find('> option:selected');
            Multiselect.$left.append($right_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$left.find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$left);
            }
        } else if (button == 'multi_d_leftAll_2') {
            var $right_options = Multiselect.$right.eq(1).children(':visible');
            Multiselect.$left.append($right_options);

            if ( typeof Multiselect.callbacks.sort == 'function' && !silent ) {
                Multiselect.$left.find('> option').sort(Multiselect.callbacks.sort).appendTo(Multiselect.$left);
            }
        }
    }
  });
  $('#submit').click(function(){
    var gene_name = $("#gene_name").val();
    var gene_upstream = $("#up").val();
    var gene_downstream = $("#down").val();
    var groupA = [];
    var groupB = [];
    $("#multi_d_to option").each(function(){
      groupA.push($(this).text());
    });
    $("#multi_d_to_2 option").each(function(){
      groupB.push($(this).text());
    });
    var info = {'gene_name': gene_name,
                'gene_upstream': gene_upstream,
                'gene_downstream': gene_downstream,
                'groupA': groupA,
                'groupB': groupB}
    if(check_gene(info)){
      info = JSON.stringify(info);
      ajaxSend('/get_gene_info',{'info': info}, function(data){
        if(data.msg != 'ok'){
          alert(data.msg);
          return;
        }else{
          tableStr = createTable(data.headData, data.bodyData);
          $("#results-table").html(tableStr);
          $("#region_table").DataTable({
            dom: 'lBfrtip',
            "scrollX": true,
            buttons: [
              'csv'
            ]
          });
        }
      }, 'POST');
    }else{
      return;
    }
    });
});
</script>
{% endblock %}
